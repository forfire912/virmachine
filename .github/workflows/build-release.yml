name: Build and Release VirMachine

on:
  push:
    tags:
      - 'v*'  # Triggered on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger

jobs:
  build-windows:
    name: Build Windows Executable
    runs-on: windows-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pyinstaller
        pip install -e .
        
    - name: Build executable
      run: |
        pyinstaller --clean virmachine.spec
        
    - name: Test executable
      run: |
        dist\VirMachine.exe --help || echo "Executable created successfully"
        
    - name: Create distribution package
      run: |
        mkdir release
        copy dist\VirMachine.exe release\
        copy README.md release\
        copy LICENSE release\
        echo "VirMachine - å›½äº§åŒ–è™šæ‹Ÿæ ·æœºç³»ç»Ÿ" > release\README.txt
        echo "" >> release\README.txt
        echo "ä½¿ç”¨æ–¹æ³• / Usage:" >> release\README.txt
        echo "åŒå‡» VirMachine.exe å¯åŠ¨äº¤äº’å¼ç•Œé¢" >> release\README.txt
        echo "Double-click VirMachine.exe to launch the interactive interface" >> release\README.txt
        
    - name: Create ZIP archive
      run: |
        cd release
        powershell Compress-Archive -Path * -DestinationPath ..\VirMachine-Windows-x64.zip
        cd ..
        
    - name: Upload artifact
      uses: actions/upload-artifact@v3
      with:
        name: VirMachine-Windows-x64
        path: VirMachine-Windows-x64.zip
        
  create-release:
    name: Create GitHub Release
    needs: build-windows
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Download Windows artifact
      uses: actions/download-artifact@v3
      with:
        name: VirMachine-Windows-x64
        
    - name: Get version from tag
      id: get_version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        name: VirMachine v${{ steps.get_version.outputs.VERSION }}
        body: |
          # å›½äº§åŒ–è™šæ‹Ÿæ ·æœºç³»ç»Ÿ / Virtual Prototyping Machine
          
          ## ç‰ˆæœ¬ / Version: ${{ steps.get_version.outputs.VERSION }}
          
          ### ä¸‹è½½ / Downloads
          
          - **Windows (64-bit)**: VirMachine-Windows-x64.zip
          
          ### ä½¿ç”¨è¯´æ˜ / Usage Instructions
          
          **Windowsç”¨æˆ· / Windows Users:**
          1. ä¸‹è½½ VirMachine-Windows-x64.zip
          2. è§£å‹ç¼©æ–‡ä»¶
          3. åŒå‡» VirMachine.exe å¯åŠ¨ç¨‹åº
          
          **English:**
          1. Download VirMachine-Windows-x64.zip
          2. Extract the archive
          3. Double-click VirMachine.exe to launch
          
          ### åŠŸèƒ½ç‰¹æ€§ / Features
          
          - ğŸ”§ ç»„ä»¶åŒ–è™šæ‹Ÿæ ·æœºè®¾è®¡ / Component-based virtual prototype design
          - ğŸ§ª ä»¿çœŸæµ‹è¯•åŠŸèƒ½ / Simulation and testing capabilities
          - ğŸŒ ä¸­è‹±æ–‡åŒè¯­æ”¯æŒ / Bilingual Chinese/English support
          - ğŸ–¥ï¸ äº¤äº’å¼ç•Œé¢ / Interactive CLI interface
          - ğŸ’¾ æ•°æ®æŒä¹…åŒ– / Data persistence (JSON)
          
          ### ç³»ç»Ÿè¦æ±‚ / System Requirements
          
          - **æ“ä½œç³»ç»Ÿ / OS**: Windows 10/11 (64-bit)
          - **å†…å­˜ / RAM**: æœ€å°‘ 512 MB / Minimum 512 MB
          - **ç£ç›˜ç©ºé—´ / Disk Space**: çº¦ 50 MB / Approximately 50 MB
          
          ---
          
          å®Œæ•´æ–‡æ¡£è¯·è®¿é—®: [README.md](https://github.com/forfire912/virmachine)
          
          For full documentation, visit: [README.md](https://github.com/forfire912/virmachine)
        files: |
          VirMachine-Windows-x64.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
